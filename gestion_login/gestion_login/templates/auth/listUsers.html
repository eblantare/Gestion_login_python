
{% extends "base.html" %}

{% block title %}Liste des utilisateurs{% endblock %}
      {% block content %}
      <div class="container bg-white text-dark p-4 rounded shadow">
        <h1 class="mb-4">LISTE DES UTILISATEURS</h1>

        <!-- Formulaire de recherche/filtre -->
         <form method="get" action="{{ url_for('auth.listUsers') }}" id="filterForm"
         class="row g-2 justify-content-center align-items-center mb-4">
            <div class="col-auto">
                <input type="text" name="search" placeholder="Recherche...." value="{{ search }}" class="form-control">
            </div>
            <div class="col-auto">
               <button type="submit" class="btn btn-primary">Rechercher</button>
            </div>
            <div class="col-auto">
                 <select name="role" class="form-select" onchange="this.form.submit()">
                <option value="">--Filtrer par rôle---</option>
                {% set role_lower = role_filter | default('') | lower %}
                {% set sel_admin = 'selected="selected"' if role_lower in ['admin','administrateur'] else '' %}
                {% set sel_user = 'selected="selected"' if role_lower == 'user' else '' %}
                <option value="admin" {{ sel_admin}}>Administrateur</option>
                <option value="user" {{ sel_user }}>Utilisateur</option>
            </select>
            </div>
            <!-- Sélectionner le nombre de ligne -->
            <div class="col-auto ms-auto d-flex align-items-center">
                <label class="me-2 fw-bold">Ligne</label>
                <select name="per_page" class="form-select" onchange="this.form.submit()">
                {% for n in [5,10,20,25,50,100,200,300,500] %}
                     {% set sel_affich = 'selected="selected"' if per_page == n else '' %}
                    <option value="{{n}}" {{ sel_affich }}> {{n}}</option>
                {% endfor %}
            </select>

            </div>

         </form>
      <div class="table-responsive"></div>
        <table class="table table-bordered table-striped">
            <thead class="table-primary">
                <tr>
                    <!-- <th scope="col">ID</th> -->
                    <th scope="col">Nom</th>
                    <th scope="col">Prénoms</th>
                    <th scope="col">Téléphone</th>
                    <th scope="col">Email</th>
                    <th scope="col">Nom d'uttilisateur</th>
                    <th scope="col">Role</th>
                    <th scope="col">Photo</th>
                    <th scope="col">Statut</th>
                    <th scope="col">Actions</th>
                </tr>
            </thead>

            <tbody>
                {% for user in users %}
                     <tr>

                        <!-- <td>{{user.id}}</td> -->
                        <td>{{user.nom}}</td>
                        <td>{{user.prenoms}}</td>
                        <td>{{user.username}}</td>
                        <td>{{user.email}}</td>
                        <td>{{user.telephone}}</td>
                        <td>{{user.role}}</td>
                        <td>
                            {% if user.photo_filename %}
                               <img src="{{ url_for('auth.static', filename='upload/' ~ user.photo_filename) }}"
                               class="user-photo" alt="{{ user.nom }}" width="50">
                            {% else %}
                            {% endif %}
                        </td>
                        <td>
                            {% if user.is_locked %}
                                <span class="badge bg-danger">Bloqué</span>
                            {% else %}
                                <span class="badge bg-danger">Actif</span>
                            {% endif %}
                        </td>
                       <td class="table-actions">
                       <!-- Icônes actions -->
                        <!-- voir détails -->
                        <!-- Détail -->
                        <button class="btn btn-link text-info" data-bs-toggle="modal" data-bs-target="#detailModal-{{ user.id }}" >
                           <i class="bi bi-eye"></i>
                       </button>
                       {% if current_user.role | lower in ['admin', 'administrateur']  %}
                     <!-- Modifier -->
                        <button class="btn btn-link text-warning" data-bs-toggle="modal" data-bs-target="#editModal-{{ user.id }}">
                        <i class="bi bi-pencil-square"></i>
                        </button>

                    <!-- Supprimer -->
                        <button class="btn btn-link text-danger" data-bs-toggle="modal" data-bs-target="#deleteModal-{{ user.id }}">
                        <i class="bi bi-trash"></i>
                        </button>
                      {% endif %}
                      </td>

                </tr>
                {% endfor %}
            </tbody>

        </table>
        {% for user in users %}
            {% include 'users/_user_detail_modal.html' %}
            {% include 'users/_user_edit_modal.html' %}
            {% include 'users/_user_delete_modal.html' %}
        {% endfor %}
        <!-- pagination -->
         <div class="pagination">
            {% if page>1 %}
                <a href="{{ url_for('auth.listUsers',search=search,role=role_filter,page=page-1,per_page=per_page)}}">&laquo;Précédent</a>
             {% endif %}
                {% for p in range(1, total_pages + 1) %}
                {% if p == page %}
                    <span class="page-item active">{{ p }}</span>
                {% else %}
                    <a href="{{ url_for('auth.listUsers',search=search, role=role_filter, page=p,per_page=per_page) }}">{{ p }}</a>
                {% endif %}
            {% endfor %}
            {% if page<total_pages %}
                 <a href="{{ url_for('auth.listUsers', search=search, role=role_filter, page=page+1, per_page=per_page) }}">Suivant &raquo;</a>
            {% endif %}
         </div>
    {% endblock %}