{% extends "ebase.html" %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Liste des Moyennes</h2>

    {# ðŸ”¹ Formulaire de filtres #}
    <form id="filterForm" method="get" action="{{ url_for('moyennes.liste_moyennes') }}" class="row g-2 mb-3 align-items-center">
        <div class="col-auto">
            <input type="text" name="search" value="{{ search }}" class="form-control" placeholder="Rechercher Ã©lÃ¨ve...">
        </div>
        <div class="col-auto">
            <select id="classeSelect" name="classe_id" class="form-select">
                <option value="">-- Classe --</option>
                {% for c in classes %}
                    <option value="{{ c.id }}" {% if classe_id == c.id|string %}selected{% endif %}>{{ c.nom }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-auto">
            <select id="anneeSelect" name="annee_scolaire" class="form-select">
                <option value="">-- AnnÃ©e --</option>
                {% for an in annees_scolaires %}
                    <option value="{{ an }}" {% if annee_scolaire == an %}selected{% endif %}>{{ an }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-auto">
            <select name="per_page" class="form-select">
                {% for n in [10,20,50,100,500,1000] %}
                    <option value="{{ n }}" {% if per_page == n %}selected{% endif %}>{{ n }} / page</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-auto">
            <button type="submit" class="btn btn-primary">Filtrer</button>
            <a href="{{ url_for('moyennes.liste_moyennes') }}" class="btn btn-secondary">RÃ©initialiser</a>
        </div>
    </form>

    {# ðŸ”¹ Bouton Batch placÃ© en haut Ã  droite du tableau #}
    {% if current_user.role in ["admin", "administrateur"] %}
    <div class="d-flex justify-content-end mb-2">
        <form id="batchForm" method="POST" action="{{ url_for('moyennes.lancer_batch') }}">
            <input type="hidden" name="classe_id" value="{{ classe_id }}">
            <input type="hidden" name="annee_scolaire" value="{{ annee_scolaire }}">
            <input type="hidden" name="trimestre" value="{{ trimestre }}">

            <button type="submit" id="batchBtn" class="btn btn-warning d-flex align-items-center px-3" disabled>
                <!-- <span id="batchBtnText">Lancer Batch</span> -->
                <img src="{{ url_for('static', filename='images/e_cone.png') }}" alt="Batch" width="22" height="22" class="ms-2" title="Calcul des moyennes">
                <span id="batchSpinner" class="spinner-border spinner-border-sm d-none ms-2"></span>
            </button>
        </form>
    </div>
    {% endif %}

    {# ðŸ”¹ Tableau des moyennes #}
    <table class="table table-striped table-bordered align-middle text-center">
        <thead class="table-dark">
            <tr>
                <th>NÂ°</th>
                <th>Ã‰lÃ¨ve</th>
                <th>Classe</th>
                <th>Moyenne</th>
                {% if trimestre == 3 %}<th>Moy_GÃ©n</th>{% endif %}
                <th>Rang</th>
                <th>Mention</th>
                <th>Moy_class</th>
            </tr>
        </thead>
        <tbody>
            {% if items %}
                {% for row in items %}
                <tr {% if row.moy_trim == row.moy_class and row.moy_trim > 0 %}class="table-success"{% endif %}>
                    <td>{{ (pagination.page - 1) * pagination.per_page + loop.index }}</td>
                    <td>{{ row.nom }} {{ row.prenoms }}</td>
                    <td>{{ row.classe_nom }}</td>
                    <td>{{ row.moy_trim if row.moy_trim > 0 else "â€”" }}</td>
                    {% if trimestre == 3 %}
                      <td>{{ row.moy_gen if row.moy_gen > 0 else "â€”" }}</td>
                    {% endif %}
                    <td>{{ row.classement_str if row.moy_trim > 0 else "â€”" }}</td>
                    <td>{{ row.appreciation if row.moy_trim > 0 else "â€”" }}</td>
                    <td>{{ row.moy_class if row.moy_trim > 0 else "â€”" }}</td>
                </tr>
                {% endfor %}

                <tr class="table-info fw-bold">
                    <td colspan="{% if trimestre == 3 %}7{% else %}6{% endif %}">
                        RÃ©sumÃ© Classe (effectif composÃ©: {{ classe_recap.effectif_composants }})
                        &nbsp;|&nbsp; Moy_class = {{ classe_recap.moy_class or "â€”" }}
                        &nbsp;|&nbsp; Moy_faible = {{ classe_recap.moy_faible or "â€”" }}
                        &nbsp;|&nbsp; Moy_forte = {{ classe_recap.moy_forte or "â€”" }}
                    </td>
                </tr>
            {% else %}
                <tr>
                    <td colspan="{% if trimestre == 3 %}8{% else %}7{% endif %}" class="text-center">Aucune moyenne disponible</td>
                </tr>
            {% endif %}
        </tbody>
    </table>

    {# ðŸ”¹ Pagination #}
    {% if pagination.pages > 1 %}
    <nav aria-label="Pagination">
        <ul class="pagination justify-content-center">
            {% set args = request.args.to_dict() %}
            {% set _ = args.pop('page', None) %}

            <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                <a class="page-link" aria-label="PrÃ©cÃ©dent"
                   href="{% if pagination.has_prev %}{{ url_for(request.endpoint, page=pagination.prev_num, **args) }}{% else %}#{% endif %}">&laquo;</a>
            </li>

            {% for p in range(1, pagination.pages + 1) %}
            <li class="page-item {% if p == pagination.page %}active{% endif %}">
                <a class="page-link" href="{{ url_for(request.endpoint, page=p, **args) }}">{{ p }}</a>
            </li>
            {% endfor %}

            <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                <a class="page-link" aria-label="Suivant"
                   href="{% if pagination.has_next %}{{ url_for(request.endpoint, page=pagination.next_num, **args) }}{% else %}#{% endif %}">&raquo;</a>
            </li>
        </ul>
    </nav>
    {% endif %}
</div>
{% endblock %}
